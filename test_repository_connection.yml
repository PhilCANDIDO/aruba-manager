---
# test_repository_connection.yml
# Playbook de test simple pour v√©rifier la connexion au serveur de d√©p√¥t

- name: Test de connexion au serveur de d√©p√¥t
  hosts: repository_servers
  gather_facts: true
  vars:
    # Variables de test (√† adapter selon votre configuration)
    test_user: "{{ ansible_user | default('deploy') }}"
    
  tasks:
    - name: Test de connectivit√© basique
      ansible.builtin.ping:
      register: ping_result
      
    - name: Afficher le r√©sultat du ping
      ansible.builtin.debug:
        msg: 
          - "‚úì Connexion r√©ussie au serveur {{ inventory_hostname }}"
          - "‚úì Utilisateur connect√©: {{ test_user }}"
          - "‚úì Ping successful: {{ ping_result.ping }}"
    
    - name: Collecter les informations syst√®me de base
      ansible.builtin.debug:
        msg:
          - "Nom d'h√¥te: {{ ansible_hostname | default('Unknown') }}"
          - "Distribution: {{ ansible_distribution | default('Unknown') }} {{ ansible_distribution_version | default('') }}"
          - "Architecture: {{ ansible_architecture | default('Unknown') }}"
          - "Utilisateur effectif: {{ ansible_user_id | default('Unknown') }}"
          - "R√©pertoire home: {{ ansible_env.HOME | default('Unknown') }}"
          
    - name: V√©rifier le r√©pertoire home de l'utilisateur
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}"
      register: home_stat
      
    - name: Afficher les informations du r√©pertoire home
      ansible.builtin.debug:
        msg:
          - "R√©pertoire home: {{ ansible_env.HOME }}"
          - "Existe: {{ home_stat.stat.exists }}"
          - "Permissions: {{ home_stat.stat.mode | default('Unknown') }}"
          - "Propri√©taire: {{ home_stat.stat.pw_name | default('Unknown') }}"
          
    - name: Lister le contenu du r√©pertoire home
      ansible.builtin.command:
        cmd: ls -la {{ ansible_env.HOME }}
      register: home_listing
      changed_when: false
      
    - name: Afficher le contenu du r√©pertoire home
      ansible.builtin.debug:
        msg: 
          - "=== CONTENU DU R√âPERTOIRE HOME ==="
          - "{{ home_listing.stdout_lines }}"
          
    - name: Test de cr√©ation d'un fichier temporaire
      ansible.builtin.tempfile:
        state: file
        suffix: .ansible_test
      register: temp_file
      
    - name: √âcrire dans le fichier temporaire
      ansible.builtin.copy:
        content: |
          Test de connexion Ansible
          Date: {{ ansible_date_time.iso8601 }}
          Utilisateur: {{ ansible_user_id }}
          Serveur: {{ inventory_hostname }}
        dest: "{{ temp_file.path }}"
        mode: '0644'
        
    - name: V√©rifier le fichier temporaire cr√©√©
      ansible.builtin.stat:
        path: "{{ temp_file.path }}"
      register: temp_file_stat
      
    - name: Lire le contenu du fichier temporaire
      ansible.builtin.slurp:
        src: "{{ temp_file.path }}"
      register: temp_file_content
      
    - name: Afficher le contenu du fichier temporaire
      ansible.builtin.debug:
        msg: 
          - "=== CONTENU DU FICHIER TEST ==="
          - "{{ temp_file_content.content | b64decode }}"
          
    - name: Nettoyer le fichier temporaire
      ansible.builtin.file:
        path: "{{ temp_file.path }}"
        state: absent
        
    - name: Tester les permissions sudo (optionnel)
      ansible.builtin.command:
        cmd: whoami
      register: whoami_result
      become: true
      failed_when: false
      
    - name: Afficher les informations sudo
      ansible.builtin.debug:
        msg:
          - "Utilisateur normal: {{ ansible_user_id }}"
          - "Utilisateur avec sudo: {{ whoami_result.stdout | default('√âchec sudo') }}"
          - "Sudo disponible: {{ whoami_result.rc == 0 }}"
      when: whoami_result is defined
      
    - name: Tester la cr√©ation d'un r√©pertoire dans un chemin sp√©cifique
      block:
        - name: Cr√©er un r√©pertoire de test
          ansible.builtin.file:
            path: "{{ ansible_env.HOME }}/ansible_test_dir"
            state: directory
            mode: '0755'
          register: test_dir_creation
          
        - name: Cr√©er un sous-r√©pertoire
          ansible.builtin.file:
            path: "{{ ansible_env.HOME }}/ansible_test_dir/subdir"
            state: directory
            mode: '0755'
            
        - name: Lister le r√©pertoire de test
          ansible.builtin.command:
            cmd: ls -la {{ ansible_env.HOME }}/ansible_test_dir
          register: test_dir_listing
          changed_when: false
          
        - name: Afficher le contenu du r√©pertoire de test
          ansible.builtin.debug:
            msg: 
              - "=== R√âPERTOIRE DE TEST CR√â√â ==="
              - "{{ test_dir_listing.stdout_lines }}"
              
        - name: Nettoyer le r√©pertoire de test
          ansible.builtin.file:
            path: "{{ ansible_env.HOME }}/ansible_test_dir"
            state: absent
            
      rescue:
        - name: Gestion d'erreur pour le test de r√©pertoire
          ansible.builtin.debug:
            msg: "‚ö†Ô∏è  Impossible de cr√©er le r√©pertoire de test: {{ ansible_failed_result.msg }}"
            
  post_tasks:
    - name: R√©sum√© du test de connexion
      ansible.builtin.debug:
        msg:
          - "================================"
          - "‚úÖ TEST DE CONNEXION TERMIN√â"
          - "================================"
          - "Serveur: {{ inventory_hostname }}"
          - "Utilisateur: {{ ansible_user_id }}"
          - "Home: {{ ansible_env.HOME }}"
          - "Sudo: {{ whoami_result.rc == 0 if whoami_result is defined else 'Non test√©' }}"
          - "√âcriture fichiers: ‚úÖ"
          - "Cr√©ation r√©pertoires: ‚úÖ"
          - "================================"
          - "üéâ Connexion au serveur de d√©p√¥t fonctionnelle"
          - "================================"