---
# T√¢ches principales pour le r√¥le firmware_updater

- name: (main) Initialize firmware update process
  block:
    - name: (main) Validate required parameters
      ansible.builtin.assert:
        that:
          - target_firmware_version is defined
          - target_firmware_version | length > 0
          - (firmware_file_path is defined and firmware_file_path | length > 0) or auto_select_firmware | bool
        fail_msg: "Le param√®tre target_firmware_version est obligatoire. firmware_file_path est requis si auto_select_firmware est d√©sactiv√©"
        success_msg: "Param√®tres requis valid√©s"
      run_once: true
      delegate_to: localhost
      tags:
        - always

    - name: (main) Initialize update tracking variables
      ansible.builtin.set_fact:
        update_start_time: "{{ '%Y-%m-%d %H:%M:%S' | strftime }}"
        update_status: "{{ 'dry_run_started' if dry_run else 'started' }}"
        update_errors: []
        rollback_performed: false
      tags:
        - always

    - name: (main) Display dry-run mode warning
      ansible.builtin.debug:
        msg:
          - "‚ö†Ô∏è  MODE DRY-RUN ACTIV√â ‚ö†Ô∏è"
          - "Aucune modification r√©elle ne sera effectu√©e"
          - "Les v√©rifications et la d√©tection seront ex√©cut√©es normalement"
          - "Switch: {{ inventory_hostname }}"
      when: dry_run | bool
      tags:
        - always

    - name: (main) Create temporary directory for update files
      ansible.builtin.tempfile:
        state: directory
        prefix: "firmware_update_"
      register: temp_update_dir
      delegate_to: localhost
      run_once: true
      tags:
        - always

    - name: (main) Set temporary paths
      ansible.builtin.set_fact:
        temp_update_path: "{{ temp_update_dir.path }}"
        temp_backup_file: "{{ temp_update_dir.path }}/config_backup_{{ inventory_hostname }}_{{ '%Y%m%d_%H%M%S' | strftime }}.cfg"
        temp_report_file: "{{ temp_update_dir.path }}/update_report_{{ inventory_hostname }}_{{ '%Y%m%d_%H%M%S' | strftime }}.md"
      delegate_to: localhost
      tags:
        - always

  rescue:
    - name: (main) Handle initialization failure
      ansible.builtin.set_fact:
        update_status: "initialization_failed"
        update_errors: "{{ update_errors + [ansible_failed_result.msg | default('Initialization failed')] }}"
      tags:
        - always

    - name: (main) Fail on initialization error
      ansible.builtin.fail:
        msg: "√âchec de l'initialisation de la mise √† jour firmware: {{ update_errors | join(', ') }}"
      tags:
        - always

# √âtape 1: V√©rification des pr√©requis
- name: (main) Check prerequisites
  import_tasks: check_prerequisites.yml
  tags:
    - check
    - always

# √âtape 2: Collecte de l'√©tat actuel
- name: (main) Collect current firmware state
  import_tasks: collect_current_state.yml
  tags:
    - check
    - always

# √âtape 2.5: D√©tection du mod√®le de switch
- name: (main) Detect switch model
  import_tasks: detect_switch_model.yml
  tags:
    - check
    - always

# √âtape 2.6: S√©lection automatique du firmware
- name: (main) Select firmware based on model
  import_tasks: select_firmware.yml
  when: auto_select_firmware | bool
  tags:
    - check
    - always

# √âtape 2.7: Validation du firmware s√©lectionn√©
- name: (main) Validate firmware file
  import_tasks: validate_firmware.yml
  when: not (dry_run | bool)
  tags:
    - validate
    - always

- name: (main) Simulate firmware validation (dry-run)
  debug:
    msg:
      - "üîç [DRY-RUN] Validerait le firmware: {{ firmware_file_path | default('N/A') }}"
      - "üîç [DRY-RUN] V√©rifierait l'existence et la taille du fichier"
      - "üîç [DRY-RUN] Contr√¥lerait le format du nom de fichier"
      - "üîç [DRY-RUN] S√©lection automatique: {{ auto_select_firmware | ternary('OUI', 'NON') }}"
  when: dry_run | bool
  tags:
    - validate
    - always

# √âtape 3: D√©termination de la strat√©gie
- name: (main) Determine update strategy
  import_tasks: determine_strategy.yml
  tags:
    - check
    - always

# √âtape 4: Sauvegarde de la configuration (si activ√©e)
- name: (main) Backup current configuration
  import_tasks: backup_config.yml
  when: 
    - backup_config | bool
    - not (dry_run | bool)
  tags:
    - backup
    - always

- name: (main) Simulate backup configuration (dry-run)
  debug:
    msg: "üîç [DRY-RUN] Sauvegarderait la configuration actuelle"
  when: 
    - backup_config | bool
    - dry_run | bool
  tags:
    - backup
    - always

# √âtape 5: Upload du firmware
- name: (main) Upload firmware
  import_tasks: upload_firmware.yml
  when: not (dry_run | bool)
  tags:
    - upload
    - always

- name: (main) Simulate firmware upload (dry-run)
  debug:
    msg: 
      - "üîç [DRY-RUN] Uploaderait le firmware: {{ firmware_file_path }}"
      - "üîç [DRY-RUN] Vers la partition: {{ chosen_partition | default('auto') }}"
      - "üîç [DRY-RUN] Strat√©gie: {{ partition_strategy }}"
  when: dry_run | bool
  tags:
    - upload
    - always

# √âtape 6: Red√©marrage du switch
- name: (main) Reboot switch with new firmware
  import_tasks: reboot_switch.yml
  when: not (dry_run | bool)
  tags:
    - reboot
    - always

- name: (main) Simulate switch reboot (dry-run)
  debug:
    msg: 
      - "üîç [DRY-RUN] Red√©marrerait le switch avec le nouveau firmware"
      - "üîç [DRY-RUN] Timeout estim√©: {{ current_reboot_timeout | default(max_reboot_time) }}s"
  when: dry_run | bool
  tags:
    - reboot
    - always

# √âtape 7: V√©rification post-update
- name: (main) Verify firmware update
  import_tasks: verify_update.yml
  when: 
    - verify_post_update | bool
    - not (dry_run | bool)
  tags:
    - verify
    - always

- name: (main) Simulate post-update verification (dry-run)
  debug:
    msg: 
      - "üîç [DRY-RUN] V√©rifierait la version firmware: {{ target_firmware_version }}"
      - "üîç [DRY-RUN] Testerait la connectivit√© et les fonctionnalit√©s"
      - "üîç [DRY-RUN] Validerait la stabilit√© du syst√®me"
  when: 
    - verify_post_update | bool
    - dry_run | bool
  tags:
    - verify
    - always

# √âtape 8: Nettoyage (optionnel)
- name: (main) Cleanup old firmware files
  import_tasks: cleanup.yml
  when: cleanup_old_firmware | bool
  tags:
    - cleanup

# Finalisation et rapport
- name: (main) Finalize update process
  block:
    - name: (main) Set completion time
      ansible.builtin.set_fact:
        update_end_time: "{{ '%Y-%m-%d %H:%M:%S' | strftime }}"
        update_status: "{{ 'dry_run_completed' if dry_run else ('completed' if update_status != 'failed' else 'failed') }}"
      tags:
        - always

    - name: (main) Generate update report
      ansible.builtin.template:
        src: update_report.md.j2
        dest: "{{ temp_report_file }}"
      delegate_to: localhost
      when: 
        - generate_report | bool
        - not (dry_run | default(false) | bool)
      tags:
        - always

    - name: (main) Generate dry-run report
      ansible.builtin.copy:
        content: |
          # Rapport Dry-Run de Mise √† Jour Firmware
          
          ## Informations G√©n√©rales
          
          | Param√®tre | Valeur |
          |-----------|--------|
          | **Switch** | {{ inventory_hostname }} |
          | **Mode** | DRY-RUN (Test uniquement) |
          | **Date** | {{ update_start_time }} |
          | **Statut** | {{ update_status | upper }} |
          
          ## Configuration Test√©e
          
          | Param√®tre | Valeur |
          |-----------|--------|
          | **Version cible** | {{ target_firmware_version }} |
          | **Mod√®le d√©tect√©** | {{ switch_model_number | default('N/A') }} ({{ switch_series | default('N/A') }} series) |
          | **Firmware s√©lectionn√©** | {{ firmware_file_path | default('N/A') }} |
          | **S√©lection automatique** | {{ auto_select_firmware | ternary('‚úì Activ√©e', '‚úó D√©sactiv√©e') }} |
          | **Strat√©gie de partition** | {{ partition_strategy | upper }} |
          | **Sauvegarde config** | {{ backup_config | ternary('‚úì Activ√©e', '‚úó D√©sactiv√©e') }} |
          
          ## R√©sultats du Test
          
          ‚úÖ **D√©tection de mod√®le** - {{ switch_model_number | default('N/A') }} identifi√©
          ‚úÖ **S√©lection firmware** - {{ firmware_file_path | default('N/A') }}
          ‚úÖ **Configuration valid√©e** - Tous les param√®tres sont corrects
          
          ## Actions Simul√©es
          
          üîç Sauvegarde de la configuration
          üîç Upload du firmware vers la partition {{ chosen_partition | default('auto') }}
          üîç Red√©marrage du switch
          üîç V√©rification de la nouvelle version
          
          ## Recommandations
          
          ‚úÖ **Test r√©ussi** - La configuration est pr√™te pour l'ex√©cution
          ‚û°Ô∏è **Prochaine √©tape** - Ex√©cuter avec `dry_run: false` pour la mise √† jour r√©elle
          
          ---
          
          **Rapport dry-run g√©n√©r√© le {{ '%Y-%m-%d %H:%M:%S' | strftime }} par Ansible Firmware Updater**
        dest: "{{ temp_report_file }}"
        mode: '0644'
      delegate_to: localhost
      when: 
        - generate_report | bool
        - dry_run | default(false) | bool
      tags:
        - always

    - name: (main) Transfer report to repository
      ansible.builtin.copy:
        src: "{{ temp_report_file }}"
        dest: "{{ repository_path }}/firmware_updates/{{ inventory_hostname }}_{{ '%Y%m%d_%H%M%S' | strftime }}_report.md"
        mode: '0644'
      delegate_to: "{{ repository_server }}"
      when: 
        - generate_report | bool
        - repository_server | length > 0
      become: true
      tags:
        - always

    - name: (main) Display update summary
      ansible.builtin.debug:
        msg:
          - "=== R√âSUM√â {{ 'DRY-RUN' if dry_run else 'DE LA MISE √Ä JOUR' }} FIRMWARE ==="
          - "Switch: {{ inventory_hostname }}"
          - "Mod√®le d√©tect√©: {{ switch_model_number | default('N/A') }} ({{ switch_series | default('N/A') }} series)"
          - "Statut: {{ update_status | upper }}"
          - "Version cible: {{ target_firmware_version }}"
          - "Firmware s√©lectionn√©: {{ firmware_file_path | default('N/A') }}"
          - "Partition utilis√©e: {{ chosen_partition | default('N/A') }}"
          - "Dur√©e totale: {{ update_duration | default('N/A') }}"
          - "{{ 'Mode: DRY-RUN - Aucune modification effectu√©e' if dry_run else 'Rollback effectu√©: ' + (rollback_performed | ternary('OUI', 'NON')) }}"
          - "Erreurs: {{ update_errors | length }}"
      tags:
        - always

  rescue:
    - name: (main) Handle update failure
      ansible.builtin.set_fact:
        update_status: "failed"
        update_end_time: "{{ '%Y-%m-%d %H:%M:%S' | strftime }}"
      tags:
        - always

    - name: (main) Log critical failure
      ansible.builtin.debug:
        msg:
          - "√âCHEC CRITIQUE de la mise √† jour firmware"
          - "Switch: {{ inventory_hostname }}"
          - "Erreur: {{ ansible_failed_result.msg | default('Erreur inconnue') }}"
      tags:
        - always

  always:
    - name: (main) Cleanup temporary files
      ansible.builtin.file:
        path: "{{ temp_update_path }}"
        state: absent
      delegate_to: localhost
      run_once: true
      when: temp_update_path is defined
      tags:
        - always
        - cleanup