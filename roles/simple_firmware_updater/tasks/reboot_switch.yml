---
# tasks/reboot_switch.yml - Redémarrage du switch sur la partition primary

- name: "(reboot_switch) Afficher le début du redémarrage"
  ansible.builtin.debug:
    msg: "{{ msg_reboot_started }}"

- name: "(reboot_switch) Sauvegarder l'heure de début du redémarrage"
  ansible.builtin.set_fact:
    reboot_start_time: "{{ lookup('pipe', 'date +%s') }}"

- name: "(reboot_switch) Configurer le boot sur primary et redémarrer"
  arubanetworks.aoscx.aoscx_boot_firmware:
    partition_name: "primary"
  register: boot_result

- name: "(reboot_switch) Afficher le résultat de la commande boot"
  ansible.builtin.debug:
    var: boot_result

- name: "(reboot_switch) Attendre que le switch redémarre (test du port 443)"
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: 443
    state: started
    timeout: 30
  delegate_to: localhost
  retries: 15
  delay: 60
  register: port_result
  until: port_result is success

- name: "(reboot_switch) Calculer la durée du redémarrage"
  ansible.builtin.set_fact:
    reboot_duration: "{{ (lookup('pipe', 'date +%s') | int) - (reboot_start_time | int) }}"

- name: "(reboot_switch) Afficher la durée du redémarrage"
  ansible.builtin.debug:
    msg: "✓ Switch redémarré avec succès en {{ reboot_duration }} secondes"