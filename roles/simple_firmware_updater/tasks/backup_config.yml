---
# tasks/backup_config.yml - Sauvegarde simplifiée de la configuration

- name: "(backup_config) Créer le répertoire temporaire local"
  ansible.builtin.file:
    path: "{{ remote_temp_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: "(backup_config) Récupérer la configuration actuelle via REST API"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}/rest/v10.11/fullconfigs/running-config"
    method: GET
    user: "{{ ansible_user }}"
    password: "{{ ansible_password }}"
    force_basic_auth: true
    validate_certs: false
    headers:
      Accept: "application/json"
  register: config_response
  delegate_to: localhost

- name: "(backup_config) Extraire la configuration du JSON"
  ansible.builtin.set_fact:
    running_config_content: "{{ config_response.json }}"

- name: "(backup_config) Sauvegarder la configuration en format JSON"
  ansible.builtin.copy:
    content: "{{ running_config_content | to_nice_json }}"
    dest: "{{ remote_temp_dir }}/{{ backup_filename }}.json"
    mode: '0644'
  delegate_to: localhost

- name: "(backup_config) Sauvegarder la configuration en format texte si disponible"
  ansible.builtin.copy:
    content: |
      # Configuration backup for {{ inventory_hostname }}
      # Date: {{ hostvars['localhost']['global_timestamp'] | default('manual') }}
      # Version: {{ primary_version | default('unknown') }}
      
      {{ running_config_content | to_nice_json }}
    dest: "{{ remote_temp_dir }}/{{ backup_filename }}"
    mode: '0644'
  delegate_to: localhost

- name: "(backup_config) Vérifier la sauvegarde locale"
  ansible.builtin.stat:
    path: "{{ remote_temp_dir }}/{{ backup_filename }}"
  register: backup_stat
  delegate_to: localhost

- name: "(backup_config) Afficher la taille du fichier de sauvegarde"
  ansible.builtin.debug:
    msg: "Fichier de sauvegarde créé: {{ backup_stat.stat.size | default(0) }} bytes"
  when: backup_stat.stat.exists | default(false)

- name: "(backup_config) Transférer la sauvegarde vers le serveur repository"
  ansible.builtin.copy:
    src: "{{ remote_temp_dir }}/{{ backup_filename }}"
    dest: "{{ backup_path }}/{{ backup_filename }}"
    mode: '0644'
  delegate_to: "{{ repository_server }}"
  become: true
  when: 
    - repository_server | length > 0
    - not (dry_run | bool)
    - backup_stat.stat.exists | default(false)

- name: "(backup_config) [DRY-RUN] Simuler le transfert de la sauvegarde"
  ansible.builtin.debug:
    msg: "{{ msg_dryrun_skip }} - Transfert de {{ backup_filename }} vers {{ repository_server }}:{{ backup_path }}"
  when:
    - repository_server | length > 0
    - dry_run | bool

- name: "(backup_config) Afficher le résumé de la sauvegarde"
  ansible.builtin.debug:
    msg: |
      {{ msg_backup_success }}
      Taille: {{ backup_stat.stat.size | default(0) }} bytes
      Emplacement: {{ repository_server }}:{{ backup_path }}/{{ backup_filename }}