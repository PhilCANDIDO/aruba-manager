---
# tasks/check_model.yml - Vérification du modèle du switch

- name: "Récupérer les facts du switch"
  arubanetworks.aoscx.aoscx_facts:
    gather_subset:
      - platform_name
      - product_info
  register: switch_facts

- name: "Extraire le modèle depuis les facts"
  ansible.builtin.set_fact:
    detected_model: "{{ switch_facts.ansible_facts.ansible_net_model | regex_search('(\\d{4})', '\\1') | first | default('unknown') }}"
  when: switch_facts.ansible_facts.ansible_net_model is defined

- name: "Gérer le cas où le modèle n'est pas trouvé"
  ansible.builtin.fail:
    msg: "ERREUR: Impossible de déterminer le modèle du switch"
  when: detected_model == 'unknown'

- name: "Afficher le modèle détecté"
  ansible.builtin.debug:
    msg: "Modèle détecté: {{ detected_model }} ({{ switch_facts.ansible_facts.ansible_net_model }})"

- name: "Vérifier la correspondance du modèle"
  ansible.builtin.fail:
    msg: "{{ msg_model_mismatch }}"
  when: detected_model != switch_model

- name: "Confirmer la correspondance du modèle"
  ansible.builtin.debug:
    msg: "✓ Le modèle {{ detected_model }} correspond au modèle attendu {{ switch_model }}"