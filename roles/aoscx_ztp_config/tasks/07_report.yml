---
# Generate CSV report and upload to TFTP server

- name: (report) Check if tftp_server group exists and has hosts
  set_fact:
    tftp_server_available: "{{ groups['tftp_server'] is defined and groups['tftp_server'] | length > 0 }}"
  run_once: true

- name: (report) Generate ZTP configuration report
  block:
    - name: (report) Gather switch facts for report
      arubanetworks.aoscx.aoscx_facts:
        gather_subset:
          - product_info      # Informations produit (modèle, série)
          - host_name         # Nom d'hôte
          - platform_name     # Nom de la plateforme
          - software_version  # Version logicielle
        gather_network_resources: []
      register: switch_facts

    - name: (report) Extract switch information from facts
      set_fact:
        report_hostname: "{{ switch_facts.ansible_facts.ansible_net_hostname | default(inventory_hostname) }}"
        report_model: "{{ switch_facts.ansible_facts.ansible_net_product_info.get('chassis,1', {}).get('product_name', 'N/A') }}"
        report_serial: "{{ switch_facts.ansible_facts.ansible_net_product_info.get('chassis,1', {}).get('serial_number', 'N/A') }}"
        report_version: "{{ switch_facts.ansible_facts.ansible_net_software_version | default('N/A') }}"
        report_platform: "{{ switch_facts.ansible_facts.ansible_net_platform_name | default('N/A') }}"

    - name: (report) Generate timestamp for report
      command: date +%Y%m%dT%H%M%S
      register: timestamp_result
      delegate_to: "{{ groups['tftp_server'][0] }}"
      run_once: true
      changed_when: false

    - name: (report) Set timestamp variable
      set_fact:
        report_timestamp: "{{ timestamp_result.stdout }}"
      run_once: true

    - name: (report) Create CSV report content
      set_fact:
        csv_content: |
          Switch,IP Address,Hostname,Platform,Model,OS Version,Serial Number,Configuration Date,Status
          {{ inventory_hostname }},{{ ansible_host }},{{ report_hostname }},{{ report_platform }},{{ report_model }},{{ report_version }},{{ report_serial }},{{ report_timestamp }},Configured

    - name: (report) Create temporary CSV file locally
      copy:
        content: "{{ csv_content }}"
        dest: "/tmp/ztp_init_{{ inventory_hostname }}_{{ report_timestamp }}.csv"
      delegate_to: "{{ groups['tftp_server'][0] }}"

    - name: (report) Ensure report directory exists on tftp_server
      file:
        path: /opt/aruba_reports/init
        state: directory
        mode: '0755'
      delegate_to: "{{ groups['tftp_server'][0] }}"
      run_once: true

    - name: (report) Copy CSV report to tftp_server
      copy:
        src: "/tmp/ztp_init_{{ inventory_hostname }}_{{ report_timestamp }}.csv"
        dest: "/opt/aruba_reports/init/ztp_init_{{ inventory_hostname }}_{{ report_timestamp }}.csv"
        mode: '0644'
        remote_src: true
      delegate_to: "{{ groups['tftp_server'][0] }}"

    - name: (report) Create consolidated report if multiple switches
      block:
        - name: (report) Initialize consolidated report
          copy:
            content: "Switch,IP Address,Hostname,Platform,Model,OS Version,Serial Number,Configuration Date,Status\n"
            dest: "/tmp/ztp_init_consolidated_{{ report_timestamp }}.csv"
          delegate_to: "{{ groups['tftp_server'][0] }}"
          run_once: true

        - name: (report) Append switch data to consolidated report
          lineinfile:
            path: "/tmp/ztp_init_consolidated_{{ report_timestamp }}.csv"
            line: "{{ inventory_hostname }},{{ ansible_host }},{{ report_hostname }},{{ report_platform }},{{ report_model }},{{ report_version }},{{ report_serial }},{{ report_timestamp }},Configured"
          delegate_to: "{{ groups['tftp_server'][0] }}"

        - name: (report) Copy consolidated report to tftp_server
          copy:
            src: "/tmp/ztp_init_consolidated_{{ report_timestamp }}.csv"
            dest: "/opt/aruba_reports/init/ztp_init_consolidated_{{ report_timestamp }}.csv"
            mode: '0644'
            remote_src: true
          delegate_to: "{{ groups['tftp_server'][0] }}"
          run_once: true

      when: play_hosts | length > 1

    - name: (report) Cleanup temporary files
      file:
        path: "{{ item }}"
        state: absent
      delegate_to: "{{ groups['tftp_server'][0] }}"
      loop:
        - "/tmp/ztp_init_{{ inventory_hostname }}_{{ report_timestamp }}.csv"
        - "/tmp/ztp_init_consolidated_{{ report_timestamp }}.csv"

    - name: (report) Display report location
      debug:
        msg: "ZTP report uploaded to {{ groups['tftp_server'][0] }}:/opt/aruba_reports/init/ztp_init_{{ inventory_hostname }}_{{ report_timestamp }}.csv"

  when: tftp_server_available | bool
